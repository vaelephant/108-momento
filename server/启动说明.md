# Momento AI Photo Management System 启动说明

## 🚀 快速启动

### 1. 环境准备

确保已安装以下软件：
- Python 3.8+
- PostgreSQL 12+
- Redis 6+

### 2. 安装依赖

```bash
# 进入项目目录
cd server

# 创建虚拟环境（可选）
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置环境变量

创建 `.env` 文件（如果还没有）：

```bash
# 复制示例配置
cp env.example .env
```

编辑 `.env` 文件，设置你的配置：

```env
# 数据库配置
DATABASE_URL=postgresql://postgres:你的密码@localhost:5432/momento
REDIS_URL=redis://localhost:6379/0

# 其他配置（可选）
DEBUG=true
SECRET_KEY=your-secret-key-here
```

### 4. 设置数据库

```bash
# 运行数据库设置脚本
python setup_database.py
```

### 5. 启动服务

#### 方式一：使用启动脚本（推荐）

```bash
python start.py
```

#### 方式二：手动启动

```bash
# 启动FastAPI服务
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 6. 验证服务

访问以下地址验证服务是否正常：

- **API文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/health
- **根路径**: http://localhost:8000/

## 🔧 详细配置

### 数据库配置

1. **创建数据库**：
```sql
CREATE DATABASE momento;
CREATE USER momento WITH PASSWORD 'momento';
GRANT ALL PRIVILEGES ON DATABASE momento TO momento;
```

2. **验证连接**：
```bash
python check_tables.py
```

### Redis配置

确保Redis服务正在运行：
```bash
# 检查Redis状态
redis-cli ping
```

### 环境变量说明

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `DATABASE_URL` | 数据库连接URL | `postgresql://momento:momento@localhost:5432/momento` |
| `REDIS_URL` | Redis连接URL | `redis://localhost:6379/0` |
| `DEBUG` | 调试模式 | `false` |
| `SECRET_KEY` | JWT密钥 | `your-secret-key-change-in-production` |
| `UPLOAD_DIR` | 文件上传目录 | `./uploads` |
| `MODEL_CACHE_DIR` | AI模型缓存目录 | `./models` |

## 🐳 Docker启动（可选）

如果使用Docker：

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 🔍 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查PostgreSQL是否运行
   - 验证数据库URL配置
   - 确认用户权限

2. **Redis连接失败**
   - 检查Redis是否运行
   - 验证Redis URL配置

3. **端口被占用**
   - 修改端口：`uvicorn app.main:app --port 8001`
   - 或停止占用端口的进程

4. **依赖包安装失败**
   - 更新pip：`pip install --upgrade pip`
   - 使用国内镜像：`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`

### 检查服务状态

```bash
# 检查配置
python app/config.py

# 检查数据库表
python check_tables.py

# 检查ChromaDB
python test_chroma.py
```

## 📊 服务监控

### 健康检查端点

- `GET /health` - 服务健康状态
- `GET /` - 服务基本信息

### 日志文件

- 应用日志：`logs/app.log`
- 错误日志：`logs/error.log`

## 🚀 生产环境部署

### 1. 环境配置

```bash
# 设置生产环境变量
export DEBUG=false
export SECRET_KEY=your-production-secret-key
export DATABASE_URL=postgresql://user:pass@prod-db:5432/momento
```

### 2. 使用Gunicorn

```bash
# 安装Gunicorn
pip install gunicorn

# 启动生产服务
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 3. 使用Nginx反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 📝 API使用示例

### 上传照片

```bash
curl -X POST "http://localhost:8000/api/v1/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@your-photo.jpg"
```

### 获取照片列表

```bash
curl "http://localhost:8000/api/v1/photos?page=1&page_size=20"
```

### 搜索照片

```bash
curl "http://localhost:8000/api/v1/search/photos?query=cat&tags=animal"
```

## 🎯 下一步

1. **启动Celery Worker**（用于AI处理）：
```bash
celery -A app.celery_app worker --loglevel=info
```

2. **配置前端连接**：
   - 修改前端API地址为 `http://localhost:8000`
   - 确保CORS配置正确

3. **开始使用**：
   - 访问 http://localhost:8000/docs 查看完整API文档
   - 上传照片测试AI标签生成
   - 使用搜索功能测试向量检索

## 📞 技术支持

如果遇到问题，请检查：
1. 所有依赖是否正确安装
2. 数据库和Redis服务是否运行
3. 环境变量配置是否正确
4. 端口是否被占用

---

🎉 **恭喜！你的Momento AI Photo Management System已经准备就绪！**
